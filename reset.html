<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>CROC â€“ Reset Password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{--bg:#0f172a;--card:#ffffff;--text:#0b1324;--muted:#6b7280;--brand:#2563eb;--line:#e5e7eb}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#0f172a,#111827)}
    .card{width:100%;max-width:460px;background:var(--card);border-radius:14px;border:1px solid var(--line);padding:22px;box-shadow:0 20px 40px rgba(0,0,0,.25)}
    h1{margin:0 0 6px;font-size:20px}
    p{margin:0 0 16px;color:var(--muted);font-size:13px}
    label{display:block;margin:10px 0 6px;font-size:13px;color:#374151}
    input{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
    .actions{display:flex;gap:8px;margin-top:14px}
    button{flex:1;padding:10px;border:0;border-radius:10px;background:var(--brand);color:#fff;cursor:pointer;font-size:14px}
    button:hover{background:#1d4ed8}
    button:disabled{background:#9ca3af;cursor:not-allowed}
    .msg{margin-top:10px;font-size:12px;display:none;border-radius:10px;padding:10px}
    .ok{display:block;color:#065f46;background:#dcfce7;border:1px solid #bbf7d0}
    .err{display:block;color:#7f1d1d;background:#fee2e2;border:1px solid #fecaca}
    .pw{position:relative}
    .pw-toggle{position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:12px;color:#374151;cursor:pointer;background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px;user-select:none}
    .pw-toggle:hover{background:#ddd6fe}
  </style>
</head>
<body>
  <div class="card">
    <h1>Reset Your Password</h1>
    
    <div id="viewReset">
      <p style="margin-top:0;">
        Choose a new password for your account. Make sure it's at least 8 characters long.
      </p>

      <label>New password</label>
      <div class="pw">
        <input id="resetNew" type="password" placeholder="At least 8 characters" autocomplete="new-password"/>
        <span id="resetNewToggle" class="pw-toggle" role="button" tabindex="0">Show</span>
      </div>

      <label>Confirm new password</label>
      <div class="pw">
        <input id="resetNew2" type="password" placeholder="Repeat new password" autocomplete="new-password"/>
        <span id="resetNew2Toggle" class="pw-toggle" role="button" tabindex="0">Show</span>
      </div>

      <div class="actions">
        <button id="btnResetPassword" type="button">Reset Password</button>
      </div>

      <div id="noteReset" class="msg"></div>
    </div>

  </div>

  <script>
    const $ = id => document.getElementById(id);

    // Helper functions
    function showMsg(el, msg, ok=true) { 
      el.className = "msg " + (ok ? "ok" : "err"); 
      el.textContent = msg; 
      el.style.display = "block"; 
    }
    
    function hideMsg(el) { 
      el.style.display = "none"; 
      el.textContent = ""; 
      el.className = "msg"; 
    }
    
    function togglePw(input, btn) {
      const go = () => { 
        const t = input.type === "password" ? "text" : "password"; 
        input.type = t; 
        btn.textContent = (t === "password" ? "Show" : "Hide"); 
      };
      btn.addEventListener("click", go); 
      btn.addEventListener("keydown", (e) => { 
        if (e.key === "Enter" || e.key === " ") { 
          e.preventDefault(); 
          go(); 
        }
      });
    }

    // Toggle password visibility
    togglePw($("resetNew"), $("resetNewToggle"));
    togglePw($("resetNew2"), $("resetNew2Toggle"));

    // API call helper
    async function call(url, payload) {
      const r = await fetch(url, { 
        method: "POST", 
        headers: { "Content-Type": "application/json" }, 
        body: JSON.stringify(payload || {}) 
      });
      const ct = (r.headers.get("content-type") || "").toLowerCase();
      const data = ct.includes("application/json") ? await r.json().catch(() => ({})) : {};
      if (!r.ok) throw new Error((data && data.error) || `HTTP ${r.status}`);
      return data;
    }

    // Get recovery token from URL hash
    function getRecoveryToken() {
      const hash = window.location.hash.substring(1); // Remove the #
      const params = new URLSearchParams(hash);
      return params.get("access_token");
    }

    // Reset password handler
    $("btnResetPassword").addEventListener("click", async () => {
      hideMsg($("noteReset"));
      const btn = $("btnResetPassword");
      
      try {
        const p1 = $("resetNew").value;
        const p2 = $("resetNew2").value;
        
        if (!p1 || p1.length < 8) {
          throw new Error("New password must be at least 8 characters.");
        }
        if (p1 !== p2) {
          throw new Error("Passwords do not match.");
        }

        const token = getRecoveryToken();
        if (!token) {
          throw new Error("No recovery token found. Please use the link from your email.");
        }

        // Disable button during request
        btn.disabled = true;
        btn.textContent = "Resetting...";

        await call("/api/auth/user/reset-confirm", { 
          token: token, 
          new_password: p1 
        });

        showMsg($("noteReset"), "Password updated successfully! You can now sign in with your new password.", true);
        
        // Clear form
        $("resetNew").value = "";
        $("resetNew2").value = "";
        
        // Optional: Redirect to login page after 3 seconds
        setTimeout(() => {
          window.location.href = "https://your-main-app.com/login.html";
        }, 3000);

      } catch (e) {
        showMsg($("noteReset"), e.message || "Could not reset password", false);
        btn.disabled = false;
        btn.textContent = "Reset Password";
      }
    });

    // Submit on Enter key
    ["resetNew", "resetNew2"].forEach(id => {
      $(id).addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          $("btnResetPassword").click();
        }
      });
    });

    // Check if we have a recovery token on page load
    window.addEventListener("DOMContentLoaded", () => {
      const token = getRecoveryToken();
      if (!token) {
        showMsg($("noteReset"), "Invalid or missing reset link. Please request a new password reset.", false);
        $("btnResetPassword").disabled = true;
      }
    });
  </script>
</body>
</html>
